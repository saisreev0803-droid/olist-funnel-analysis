with base_orders as (select c.customer_unique_id as user_id, o.order_id,safe_cast(o.order_purchase_timestamp as TIMESTAMP) as order_purchase_ts, safe_cast(o.order_approved_at as timestamp) as order_approved_ts, safe_cast(o.order_delivered_carrier_date as timestamp) as order_shipped_ts, safe_cast(o.order_delivered_customer_date as timestamp) as order_delivered_ts from olist-funnel-analysis.funnel_project.orders o join olist-funnel-analysis.funnel_project.customers c on o.customer_id = c.customer_id ),
signup as (select user_id, min(order_purchase_ts) as signup_time from base_orders where order_purchase_ts is not null group by 1)
select s.user_id, s.signup_time,
min(if(b.order_approved_ts is not null and b.order_approved_ts >= s.signup_time and b.order_approved_ts < timestamp_add(s.signup_time, INTERVAL 7 DAY), b.order_approved_ts,NULL)) as approved_time, 
min(if(b.order_shipped_ts is not null and b.order_shipped_ts >= s.signup_time and b.order_shipped_ts < timestamp_add(s.signup_time, interval 7 day), b.order_shipped_ts, null)) as shipped_time, min(if(b.order_delivered_ts is not null and b.order_delivered_ts >= s.signup_time and b.order_delivered_ts < timestamp_add(s.signup_time, interval 7 day), b.order_delivered_ts, null)) as purchase_time from signup s left join base_orders b on s.user_id = b.user_id group by 1,2;